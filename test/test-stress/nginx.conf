worker_processes  1;

events {
    worker_connections  1024;
}

http {
  #limit concurrent connections to each load balanced server
  limit_conn_zone $server_addr zone=max_connections_per_server:20m;

  #local machine
  limit_req_zone $binary_remote_addr zone=max_upgrades_per_client:20m rate=5r/s;

  #max connection attempts per server
  limit_req_zone $server_addr zone=max_upgrades_per_server:20m rate=50r/s;

  server {
    listen 60000;
    server_name localhost;

    location /primus {

      #maximum allowed concurrent connections per proxy target
      limit_conn max_connections_per_server 5000;

      #max_upgrades_per_server
      limit_req zone=max_upgrades_per_server burst=100;

      #maximum allowed connection upgrade requests
      limit_req zone=max_upgrades_per_client burst=10;

      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $host;

      proxy_pass http://ws-backend;

      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
    }

    location / {
      proxy_set_header Host $host;
      proxy_pass http://ws-backend;
    }
  }

  upstream ws-backend {

    # enable sticky session based on IP
    # nip_hash;

    # we load balance upgrade requests between the cluster brokers
    server localhost:55001;
    server localhost:55002;
    server localhost:55003;
    # server localhost:55004;
    # server localhost:55005;
    # server localhost:55006;
    # server localhost:55007;
    # server localhost:55008;
    # server localhost:55009;
  }
}
